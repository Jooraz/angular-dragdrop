/**
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */

/**
 * Implementing Drag and Drop functionality in AngularJS is easier than ever.
 * Demo: http://codef0rmer.github.com/angular-dragdrop/
 * 
 * @version 1.0.13
 *
 * (c) 2013 Amit Gharat a.k.a codef0rmer <amit.2006.it@gmail.com> - amitgharat.wordpress.com
 */
!function(e,t,a,n){"use strict";var i=t.module("ngDragDrop",[]).service("ngDragDropService",["$timeout","$parse","$q",function(r,l,o){this.draggableScope=null,this.droppableScope=null,a("head").prepend('<style type="text/css">@charset "UTF-8";.angular-dragdrop-hide{display: none !important;}</style>'),this.callEventCallback=function(e,t,n,i){if(t){var r=function(t){var n=-1!==t.indexOf("(")?t.indexOf("("):t.length,i=-1!==t.lastIndexOf(")")?t.lastIndexOf(")"):t.length,r=t.substring(n+1,i),o=-1!==t.indexOf(".")?t.substr(0,t.indexOf(".")):null;return o=e[o]&&"function"==typeof e[o].constructor?o:null,{callback:t.substring(o&&o.length+1||0,n),args:a.map(r&&r.split(",")||[],(function(t){return[l(t)(e)]})),constructor:o}}(t),o=r.callback,s=r.constructor,d=[n,i].concat(r.args);return(e[o]||e[s][o]).apply(e[o]?e:e[s],d)}},this.invokeDrop=function(e,l,s,d){var p,c,u,g,f,b,h={},v={},y={},x={},m=null,D=this.droppableScope,q=this.draggableScope,j=null,k=[];p=e.ngattr("ng-model"),c=l.ngattr("ng-model"),g=q.$eval(p),f=D.$eval(c),m=l.find("[jqyoui-draggable]:last,[data-jqyoui-draggable]:last"),v=D.$eval(l.attr("jqyoui-droppable")||l.attr("data-jqyoui-droppable"))||[],(h=q.$eval(e.attr("jqyoui-draggable")||e.attr("data-jqyoui-draggable"))||[]).index=this.fixIndex(q,h,g),v.index=this.fixIndex(D,v,f),u=t.isArray(g)?h.index:null,y=t.isArray(g)?g[u]:g,h.deepCopy&&(y=t.copy(y)),x=t.isArray(f)&&v&&v.index!==n?f[v.index]:t.isArray(f)?{}:f,v.deepCopy&&(x=t.copy(x)),h.beforeDrop&&k.push(this.callEventCallback(q,h.beforeDrop,s,d)),o.all(k).then(t.bind(this,(function(){if(h.insertInline&&p===c){if(h.index>v.index){b=g[h.index];for(var n=h.index;n>v.index;n--)f[n]=t.copy(f[n-1]),f[n-1]={},f[n][h.direction]="left";f[v.index]=b}else{b=g[h.index];for(n=h.index;n<v.index;n++)f[n]=t.copy(f[n+1]),f[n+1]={},f[n][h.direction]="right";f[v.index]=b}this.callEventCallback(D,v.onDrop,s,d)}else!0===h.animate?((j=e.clone()).css({position:"absolute"}).css(e.offset()),a("body").append(j),e.addClass("angular-dragdrop-hide"),this.move(j,m.length>0?m:l,null,"fast",v,(function(){j.remove()})),this.move(m.length>0&&!v.multiple?m:[],e.parent("[jqyoui-droppable],[data-jqyoui-droppable]"),i.startXY,"fast",v,t.bind(this,(function(){r(t.bind(this,(function(){e.css({position:"relative",left:"",top:""}).removeClass("angular-dragdrop-hide"),m.css({position:"relative",left:"",top:"",display:"none"===m.css("display")?"":m.css("display")}),this.mutateDraggable(q,v,h,p,c,x,e),this.mutateDroppable(D,v,h,c,y,u),this.callEventCallback(D,v.onDrop,s,d)})))})))):r(t.bind(this,(function(){this.mutateDraggable(q,v,h,p,c,x,e),this.mutateDroppable(D,v,h,c,y,u),this.callEventCallback(D,v.onDrop,s,d)})))}))).finally(t.bind(this,(function(){this.restore(e)})))},this.move=function(t,a,i,r,l,o){if(0===t.length)return o&&e.setTimeout((function(){o()}),300),!1;var s=t.css("z-index"),d=t[l.containment||"offset"](),p=a.css("display"),c=a.hasClass("ng-hide"),u=a.hasClass("angular-dragdrop-hide");null===i&&a.length>0&&((a.attr("jqyoui-draggable")||a.attr("data-jqyoui-draggable"))!==n&&a.ngattr("ng-model")!==n&&a.is(":visible")&&l&&l.multiple?(i=a[l.containment||"offset"](),!1===l.stack?i.left+=a.outerWidth(!0):i.top+=a.outerHeight(!0)):(c&&a.removeClass("ng-hide"),u&&a.removeClass("angular-dragdrop-hide"),i=a.css({visibility:"hidden",display:"block"})[l.containment||"offset"](),a.css({visibility:"",display:p}))),t.css({position:"absolute","z-index":9999}).css(d).animate(i,r,(function(){c&&a.addClass("ng-hide"),u&&a.addClass("angular-dragdrop-hide"),t.css("z-index",s),o&&o()}))},this.mutateDroppable=function(e,a,n,i,r,o){var s=e.$eval(i);e.dndDragItem=r,t.isArray(s)?(a&&a.index>=0?s[a.index]=r:s.push(r),n&&!0===n.placeholder&&(s[s.length-1].jqyoui_pos=o)):(l(i+" = dndDragItem")(e),n&&!0===n.placeholder&&(s.jqyoui_pos=o))},this.mutateDraggable=function(e,a,i,r,o,s,d){var p=t.equals(s,{})||!s,c=e.$eval(r);e.dndDropItem=s,i&&i.placeholder?"keep"!=i.placeholder&&(t.isArray(c)&&i.index!==n?c[i.index]=s:l(r+" = dndDropItem")(e)):t.isArray(c)?p?i&&!0!==i.placeholder&&"keep"!==i.placeholder&&c.splice(i.index,1):c[i.index]=s:(l(r+" = dndDropItem")(e),e.$parent&&l(r+" = dndDropItem")(e.$parent)),this.restore(d)},this.restore=function(e){e.css({"z-index":"",left:"",top:""})},this.fixIndex=function(e,a,i){if(a.applyFilter&&t.isArray(i)&&i.length>0){var r=e[a.applyFilter]()[a.index],l=n;return i.forEach((function(e,a){t.equals(e,r)&&(l=a)})),l}return a.index}}]).directive("jqyouiDraggable",["ngDragDropService",function(e){return{require:"?jqyouiDroppable",restrict:"A",link:function(n,r,l){var o,s,d,p,c=a(r),u=function(r,u){r?(o=n.$eval(c.attr("jqyoui-draggable")||c.attr("data-jqyoui-draggable"))||{},s=n.$eval(l.jqyouiOptions)||{},c.draggable({disabled:!1}).draggable(s).draggable({start:function(t,r){e.draggableScope=n,d=a(s.helper?r.helper:this).css("z-index"),a(s.helper?r.helper:this).css("z-index",9999),i.startXY=a(this)[o.containment||"offset"](),e.callEventCallback(n,o.onStart,t,r)},stop:function(t,i){a(s.helper?i.helper:this).css("z-index",d),e.callEventCallback(n,o.onStop,t,i)},drag:function(t,a){e.callEventCallback(n,o.onDrag,t,a)}})):c.draggable({disabled:!0}),p&&t.isDefined(r)&&(t.equals(l.drag,"true")||t.equals(l.drag,"false"))&&(p(),p=null)};p=n.$watch((function(){return n.$eval(l.drag)}),u),u(),r.on("$destroy",(function(){setTimeout((function(){c.draggable({disabled:!0}).draggable("destroy")}))}))}}}]).directive("jqyouiDroppable",["ngDragDropService","$q",function(e,n){return{restrict:"A",priority:1,link:function(i,r,l){var o,s,d,p=a(r),c=function(r,c){r?(o=i.$eval(a(p).attr("jqyoui-droppable")||a(p).attr("data-jqyoui-droppable"))||{},s=i.$eval(l.jqyouiOptions)||{},p.droppable({disabled:!1}).droppable(s).droppable({over:function(t,a){e.callEventCallback(i,o.onOver,t,a)},out:function(t,a){e.callEventCallback(i,o.onOut,t,a)},drop:function(r,d){var p,c=null;o.beforeDrop?c=e.callEventCallback(i,o.beforeDrop,r,d):((p=n.defer()).resolve(),c=p.promise),c.then(t.bind(this,(function(){a(d.draggable).ngattr("ng-model")&&l.ngModel?(e.droppableScope=i,e.invokeDrop(a(d.draggable),a(this),r,d)):e.callEventCallback(i,o.onDrop,r,d)})),(function(){d.draggable.animate({left:"",top:""},s.revertDuration||0)}))}})):p.droppable({disabled:!0}),d&&t.isDefined(r)&&(t.equals(l.drop,"true")||t.equals(l.drop,"false"))&&(d(),d=null)};d=i.$watch((function(){return i.$eval(l.drop)}),c),c(),r.on("$destroy",(function(){setTimeout((function(){p.draggable({disabled:!0}).draggable("destroy")}))}))}}}]);a.fn.ngattr=function(e,t){var a=this[0];return a.getAttribute(e)||a.getAttribute("data-"+e)}}(window,window.angular,window.jQuery);
